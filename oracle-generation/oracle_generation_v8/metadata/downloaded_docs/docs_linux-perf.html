<!doctype html><html lang=en><meta charset=utf-8><title>V8’s Linux perf integration · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/favicon.png rel=icon sizes=48x48><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="This document explains how to analyze the performance of V8’s JITted code with the Linux `perf` tool." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>Show navigation</a><nav><ul><li><a href=/ >Home</a><li><a href=/blog>Blog</a><li class=current><a href=/docs>Docs</a><li><a href=/tools>Tools</a><li><a href=/features title="JavaScript and WebAssembly language features">JS/Wasm features</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><h1>V8’s Linux <code>perf</code> integration</h1><p>V8 has built-in support for the Linux <code>perf</code> tool. It is enable by the <code>--perf-prof</code> command-line options.<br>V8 writes out performance data during execution into a file that can be used to analyze the performance of V8’s JITted code (including JS-function names) with the Linux <code>perf</code> tool.<h2 id=requirements tabindex=-1>Requirements <a href=#requirements class=bookmark>#</a></h2><ul><li><code>linux-perf</code> version 5 or higher (previous version don't have jit support). (See instructions at the <a href=#build-perf>end</a>)<li>Build V8/Chrome with <code>enable_profiling=true</code> for better symbolized C++ code.</ul><h2 id=building-v8 tabindex=-1>Building V8 <a href=#building-v8 class=bookmark>#</a></h2><p>To use V8’s integration with Linux perf you need to build it with the <code>enable_profiling = true</code> gn flag:<pre class=language-bash><code class=language-bash><span class="token builtin class-name">echo</span> <span class="token string">'enable_profiling = true'</span> <span class="token operator">>></span> out/x64.release/args.gn<br>autoninja <span class="token variable parameter">-C</span> out/x64.release</code></pre><h2 id=profiling-d8-with-linux-perf-d8.py tabindex=-1>Profiling <code>d8</code> with <a href="https://source.chromium.org/search?q=linux-perf-d8.py"><code>linux-perf-d8.py</code></a> <a href=#profiling-d8-with-linux-perf-d8.py class=bookmark>#</a></h2><p>After building <code>d8</code>, you can start using linux perf:<pre class=language-bash><code class=language-bash>tools/profiling/linux-perf-d8.py out/x64.release/d8 path/to/test.js<span class="token punctuation">;</span></code></pre><p>A more complete example:<pre class=language-bash><code class=language-bash><span class="token builtin class-name">echo</span> <span class="token string">'(function f() {<br>    var s = 0; for (var i = 0; i &lt; 1000000000; i++) { s += i; } return s;<br>  })();'</span> <span class="token operator">></span> test.js<span class="token punctuation">;</span><br><br><span class="token comment"># Use custom V8 flags and a separate output dir for less clutter:</span><br><span class="token function">mkdir</span> perf_results<br>tools/profiling/linux-perf-d8.py --perf-data-dir<span class="token operator">=</span>perf_results <span class="token punctuation">\</span><br>    out/x64.release/d8 --expose-gc --allow-natives-syntax test.js<span class="token punctuation">;</span><br><br><span class="token comment"># Fancy UI (`-flame` is googler-only, use `-web` as a public alternative):</span><br>pprof <span class="token variable parameter">-flame</span> perf_results/XXX_perf.data.jitted<span class="token punctuation">;</span><br><span class="token comment"># Terminal-based tool:</span><br>perf report <span class="token variable parameter">-i</span> perf_results/XXX_perf.data.jitted<span class="token punctuation">;</span></code></pre><p>Check <code>linux-perf-d8.py --help</code> for more details. Note that you can use all <code>d8</code> flags after the d8 binary argument.<h2 id=profiling-chrome-or-content_shell-with-linux-perf-chrome.py tabindex=-1>Profiling Chrome or content_shell with <a href="https://source.chromium.org/search?q=linux-perf-chrome.py">linux-perf-chrome.py</a> <a href=#profiling-chrome-or-content_shell-with-linux-perf-chrome.py class=bookmark>#</a></h2><ol><li><p>You can use the <a href="https://source.chromium.org/search?q=linux-perf-chrome.py">linux-perf-chrome.py</a> script to profile chrome. Make sure to add the <a href=https://chromium.googlesource.com/chromium/src/+/master/docs/profiling.md#General-checkout-setup>required chrome gn flags</a> to get proper C++ symbols.<li><p>Once your build is ready, you can profile a website with both, full symbols for C++ and JS code.<pre class=language-bash><code class=language-bash><span class="token function">mkdir</span> perf_results<span class="token punctuation">;</span><br>tools/profiling/linux-perf-chrome.py out/x64.release/chrome <span class="token punctuation">\</span><br>    --perf-data-dir<span class="token operator">=</span>perf_results <span class="token variable parameter">--timeout</span><span class="token operator">=</span><span class="token number">30</span></code></pre><li><p>Navigate to your website and then close the browser (or wait for the <code>--timeout</code> to complete)<li><p>After quitting the browser <code>linux-perf.py</code> will post-process the files and show a list with a result file for each renderer process:<pre><code>chrome_renderer_1583105_3.perf.data.jitted      19.79MiB
chrome_renderer_1583105_2.perf.data.jitted       8.59MiB
chrome_renderer_1583105_4.perf.data.jitted       0.18MiB
chrome_renderer_1583105_1.perf.data.jitted       0.16MiB
</code></pre></ol><h2 id=exploring-linux-perf-results tabindex=-1>Exploring linux-perf results <a href=#exploring-linux-perf-results class=bookmark>#</a></h2><p>Finally you can use the Linux <code>perf</code> tool to explore the profile of a d8 or chrome renderer process:<pre class=language-bash><code class=language-bash>perf report <span class="token variable parameter">-i</span> perf_results/XXX_perf.data.jitted</code></pre><p>You can also use <a href=https://github.com/google/pprof>pprof</a> to generate more visualizations:<pre class=language-bash><code class=language-bash><span class="token comment"># Note: `-flame` is google-only, use `-web` as a public alternative:</span><br>pprof <span class="token variable parameter">-flame</span> perf_results/XXX_perf.data.jitted<span class="token punctuation">;</span></code></pre><h2 id=low-level-linux-perf-usage tabindex=-1>Low-level linux-perf usage <a href=#low-level-linux-perf-usage class=bookmark>#</a></h2><h3 id=using-linux-perf-with-d8-directly tabindex=-1>Using linux-perf with <code>d8</code> directly <a href=#using-linux-perf-with-d8-directly class=bookmark>#</a></h3><p>Depending on your use-case you might want to resort to using linux-perf directly with <code>d8</code>.<br>This requires a two-step process, first <code>perf record</code> creates a <code>perf.data</code> file that has to be post-processed with <code>perf inject</code> to inject the JS-symbols.<pre class=language-bash><code class=language-bash>perf record --call-graph<span class="token operator">=</span>fp <span class="token variable parameter">--clockid</span><span class="token operator">=</span>mono <span class="token variable parameter">--freq</span><span class="token operator">=</span>max <span class="token punctuation">\</span><br>    <span class="token variable parameter">--output</span><span class="token operator">=</span>perf.data<br>    out/x64.release/d8 <span class="token punctuation">\</span><br>      --perf-prof --no-write-protect-code-memory <span class="token punctuation">\</span><br>      --interpreted-frames-native-stack <span class="token punctuation">\</span><br>    test.js<span class="token punctuation">;</span><br>perf inject <span class="token variable parameter">--jit</span> <span class="token variable parameter">--input</span><span class="token operator">=</span>perf.data <span class="token variable parameter">--output</span><span class="token operator">=</span>perf.data.jitted<span class="token punctuation">;</span><br>perf report <span class="token variable parameter">--input</span><span class="token operator">=</span>perf.data.jitted<span class="token punctuation">;</span></code></pre><h3 id=v8-linux-perf-flags tabindex=-1>V8 linux-perf Flags <a href=#v8-linux-perf-flags class=bookmark>#</a></h3><p><a href="https://source.chromium.org/search?q=FLAG_perf_prof"><code>--perf-prof</code></a> is used to the V8 command-line to record performance samples in JIT code.<p><a href="https://source.chromium.org/search?q=FLAG_nowrite_protect_code_memory"><code>--nowrite-protect-code-memory</code></a> is required to disable write protection for code memory. This is necessary because <code>perf</code> discards information about code pages when it sees the event corresponding to removing the write bit from the code page. Here’s an example that records samples from a test JavaScript file:<p><a href="https://source.chromium.org/search?q=FLAG_interpreted_frames_native_stack"><code>--interpreted-frames-native-stack</code></a> is used to create different entry points (copied versions of InterpreterEntryTrampoline) for interpreted functions so they can be distinguished by <code>perf</code> based on the address alone. Since the InterpreterEntryTrampoline has to be copied this comes at slight performance and memory regression.<h3 id=using-linux-perf-with-chrome-directly tabindex=-1>Using linux-perf with chrome directly <a href=#using-linux-perf-with-chrome-directly class=bookmark>#</a></h3><ol><li><p>You can use the same V8 flags to profile chrome itself. Follow the instructions above for the correct V8 flags and add the <a href=https://chromium.googlesource.com/chromium/src/+/master/docs/profiling.md#General-checkout-setup>required chrome gn flags</a> to your chrome build.<li><p>Once your build is ready, you can profile a website with both, full symbols for C++ and JS code.<pre class=language-bash><code class=language-bash>out/x64.release/chrome <span class="token punctuation">\</span><br>    --user-data-dir<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>mktemp <span class="token variable parameter">-d</span><span class="token variable">`</span></span> <span class="token punctuation">\</span><br>    --no-sandbox <span class="token variable parameter">--incognito</span> --enable-benchmarking <span class="token punctuation">\</span><br>    --js-flags<span class="token operator">=</span><span class="token string">'--perf-prof --no-write-protect-code-memory --interpreted-frames-native-stack'</span></code></pre><li><p>After starting up chrome, find the renderer process id using the Task Manager and use it to start profiling:<pre class=language-bash><code class=language-bash>perf record <span class="token variable parameter">-g</span> <span class="token variable parameter">-k</span> mono <span class="token variable parameter">-p</span> <span class="token variable">$RENDERER_PID</span> <span class="token variable parameter">-o</span> perf.data</code></pre><li><p>Navigate to your website and then continue with the next section on how to evaluate the perf output.<li><p>After execution finishes, combine the static information gathered from the <code>perf</code> tool with the performance samples output by V8 for JIT code:<pre class=language-bash><code class=language-bash>perf inject <span class="token variable parameter">--jit</span> <span class="token variable parameter">--input</span><span class="token operator">=</span>perf.data <span class="token variable parameter">--output</span><span class="token operator">=</span>perf.data.jitted</code></pre><li><p>Finally you can use the Linux <code>perf</code> <a href=#Explore-linux-perf-results>tool to explore</a></ol><h2 id=build-perf tabindex=-1>Build <code>perf</code> <a href=#build-perf class=bookmark>#</a></h2><p>If you have an outdated linux kernel you can build linux-perf with jit support locally.<ul><li><p>Install a new Linux kernel, and then reboot your machine:<pre class=language-bash><code class=language-bash> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> linux-generic-lts-wily<span class="token punctuation">;</span></code></pre><li><p>Install dependencies:<pre class=language-bash><code class=language-bash><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libdw-dev libunwind8-dev systemtap-sdt-dev libaudit-dev <span class="token punctuation">\</span><br>   libslang2-dev binutils-dev liblzma-dev<span class="token punctuation">;</span></code></pre><li><p>Download kernel sources that include the latest <code>perf</code> tool source:<pre class=language-bash><code class=language-bash><span class="token builtin class-name">cd</span> some/directory<span class="token punctuation">;</span><br><span class="token function">git</span> clone <span class="token variable parameter">--depth</span> <span class="token number">1</span> git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git<span class="token punctuation">;</span><br><span class="token builtin class-name">cd</span> tip/tools/perf<span class="token punctuation">;</span><br><span class="token function">make</span></code></pre></ul><p>In the following steps, invoke <code>perf</code> as <code>some/director/tip/tools/perf/perf</code>.</main><footer id=footer><div><nav><a href=/logo>Branding</a> <a href=/terms>Terms</a> <a href=https://policies.google.com/privacy>Privacy</a> <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> <a href=https://github.com/v8/v8.dev/tree/main/./src/docs/linux-perf.md rel=nofollow>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Mode" light="Dark Mode" permanent></dark-mode-toggle></div><p><small>Except as otherwise noted, any code samples from the V8 project are licensed under <a href=https://chromium.googlesource.com/v8/v8.git/+/main/LICENSE>V8’s BSD-style license</a>. Other content on this page is licensed under <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a>. For details, see <a href=/terms#site-policies>our site policies</a>.</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.js></script>